#!/bin/bash

# Needed softwares
softs="g++ moc-qt4 qmake lupdate lrelease make"
cxx_devs="iterator string vector sstream iostream"
xml_devs="libxml++"

echo "*****************************"
echo "* Checking configuration... *"
echo "*****************************" 
for soft in $softs
do
    path=`which $soft`
    if [ $path = "" ]
    then
        echo $soft missing !
        exit
    else
        echo $soft: $path        
    fi
done
echo 

echo "*********************************"
echo "* Checking development files... *"
echo "*********************************"

cxx_version=`g++ --version | sed -e "s/g++.*(.*) //" | grep -o -e "[0-9]\{1,\}\.[0-9]\{1,\}"`
cxx_dev_path="/usr/include/c++/$cxx_version"
echo - C++ standard library: $cxx_dev_path
for dev in $cxx_devs
do
    if [ -e "$cxx_dev_path/$dev" ]
    then
        echo $dev: OK
    else
        echo $dev missing !
        exit
    fi
done

echo
xml_dev_path=`ls -l /usr/include/ | grep -o -e "libxml++-[0-9]\{1,\}\.[0-9]\{1,\}" | head -n 1`
echo - XML++ library: /usr/include/$xml_dev_path
for dev in $xml_devs
do
    if [ -e "/usr/include/$xml_dev_path/libxml++/$dev.h" ]
    then
        echo $dev.h: OK
    else
        echo $dev.h missing !
        exit
    fi
done

echo
echo "*****************************"
echo "* Preparing the compilation *"
echo "*****************************"


qmake -project
lupdate GM-Assistant.pro
lrelease GM-Assistant.pro
mv translations/*.qm .
qmake

# adding libxml++ library includes in the Makefile
sed -i -e "s#-I\.#`pkg-config $xml_dev_path --cflags | sed -e "s/-pthread //"`#" Makefile
sed -i -e "s#-lpthread#-lpthread `pkg-config $xml_dev_path --libs`#" Makefile

echo
echo "********************"
echo "* Ready to compile *"
echo "********************"
echo To compile, type make
