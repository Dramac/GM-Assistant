##########################################################################
# Copyright Â© 2011 Vincent Prat & Simon Nicolas
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
##########################################################################

#!/bin/sh

# Initializing some options
debug="false"
prefix="$HOME/GM-Assistant"

# Reading options
supported_short_options="gh"
supported_long_options="help,debug,prefix:"

options=$(getopt -s sh -l $supported_long_options $supported_short_options $@)
if [ $? -eq 1 ]   # unsupported options
then
    echo "Try the --help option for more information"
    exit 1
fi

# initialization
arg=0
for opt in $options
do
    if [ $arg -eq 0 -o "$opt" = "--" ]
    then
        case $opt in
            -g | --debug)   debug="true";;
            -h | --help)    echo -e "Usage: configure [options]\n\n -g, --debug\tEnable debugging\n -h, --help\tDisplay this usage guide\n --prefix=dir\t'make install' will install this software in dir"
                exit 0;;
            --prefix)       arg=1;;
            --) break;;
        esac
    else
        prefix=$opt
        arg=0
    fi
done

# Find the OS
OS=$(uname)
echo "******************************"
echo "* Detecting operating system *"
echo "******************************"
echo
echo Operating system: $OS
# OS-dependent variables
if [ $OS = "Linux" ]
then
	softs="moc-qt4"
	inc_path="/usr/include/"
    sed_i="-i"
elif [ $OS = "Darwin" ]
then
	softs="moc"
	inc_path="/opt/local/include/"
    sed_i='-i ""'
fi

echo
echo "*************************"
echo "* Checking softwares... *"
echo "*************************" 
echo

# Needed softwares
softs="$softs uname echo getopt ls grep head pkg-config g++ qmake lupdate lrelease make mv sed mkdir cp rmdir sort"

for soft in $softs
do
    path=$(which $soft)
    if [ $? = 1 ]
    then
        echo $soft missing !
        exit
    else
        echo $soft: $path        
    fi
done
echo 

echo "*********************************"
echo "* Checking development files... *"
echo "*********************************"

# Needed headers

# libXML++
echo
echo libXML++:
xml_devs="libxml++"
xml_dev_path=$(ls -l $inc_path | grep -o -e "libxml++-[0-9]\{1,\}\.[0-9]\{1,\}" | head -n 1)

for dev in $xml_devs
do
    if [ -e "$inc_path$xml_dev_path/libxml++/$dev.h" ]
    then
        echo $inc_path$xml_dev_path/libxml++/$dev.h: OK
    else
        echo $dev.h missing !
        exit
    fi
done

# SDL
echo
echo SDL:
sdl_devs="SDL_mixer SDL_sound"
sdl_dev_path=$inc_path"SDL"

for dev in $sdl_devs
do
    if [ -e "$sdl_dev_path/$dev.h" ]
    then
        echo $sdl_dev_path/$dev.h: OK
    else
        echo $dev.h missing !
        exit
    fi
done

echo
echo "********************************"
echo "* Preparing the compilation... *"
echo "********************************"
echo

qmake -project
lupdate GM-Assistant.pro
lrelease GM-Assistant.pro
qmake

# adding the -g flag if the debug option is enabled
if [ $debug = "true" ]
then
    sed $sed_i "s#-pipe#-pipe -g#" Makefile
fi

echo
echo "************************"
echo "* Adding librairies... *"
echo "************************"
echo

echo $xml_dev_path
echo SDL
echo SDL_mixer
echo SDL_sound

# adding libxml++ and SDL includes in the Makefile
sed $sed_i "s#-I\.#$(pkg-config $xml_dev_path --cflags-only-I) $(pkg-config sdl --cflags-only-I)#" Makefile

# adding libxml++ and SDL binaries
sed $sed_i "s#-lQtCore#-lQtCore $(pkg-config $xml_dev_path --libs) -lSDL_mixer -lSDL_sound#" Makefile

# cleaning previous compilation
make -s clean
rm -f *.o
rm -f ui_*.h

echo
echo "********************"
echo "* Ready to compile *"
echo "********************"
echo
echo To compile, type make

# preparing the installation
prefix=$(echo $prefix | sed "s#\~#$HOME#")
sed $sed_i "s#^install:.*#install:\n\t\@\.\/install.sh $prefix#" Makefile
sed $sed_i "s#^uninstall:.*#uninstall:\n\t\@\.\/uninstall.sh#" Makefile
